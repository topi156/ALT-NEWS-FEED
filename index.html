<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ALT Intel â€“ Private Markets Intelligence</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;0,900;1,400&family=JetBrains+Mono:wght@300;400;500;700&family=Crimson+Pro:ital,wght@0,300;0,400;1,300&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f5f2eb;
  --bg2: #ede9df;
  --surface: #ffffff;
  --ink: #1a1612;
  --ink-mid: #4a4540;
  --ink-dim: #8a8278;
  --rule: #d8d2c4;
  --accent: #c4381a;
  --accent2: #1a4a8a;
  --gold: #b8860b;
  --pe-c: #c4381a;
  --credit-c: #1a4a8a;
  --infra-c: #2a6a3a;
  --re-c: #7a3a1a;
  --hedge-c: #4a1a7a;
  --macro-c: #1a5a6a;
}

* { margin:0; padding:0; box-sizing:border-box; }

body {
  background: var(--bg);
  color: var(--ink);
  font-family: 'Crimson Pro', Georgia, serif;
  min-height: 100vh;
  font-size: 16px;
}

/* Paper texture */
body::before {
  content: '';
  position: fixed; inset: 0;
  background-image:
    repeating-linear-gradient(0deg, transparent, transparent 28px, rgba(0,0,0,0.015) 28px, rgba(0,0,0,0.015) 29px);
  pointer-events: none;
  z-index: 0;
}

/* â”€â”€ MASTHEAD â”€â”€ */
.masthead {
  border-bottom: 3px double var(--ink);
  padding: 0 48px;
  background: var(--bg);
  position: sticky;
  top: 0;
  z-index: 200;
}

.masthead-top {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 0 12px;
  border-bottom: 1px solid var(--ink);
}

.pub-name {
  font-family: 'Playfair Display', Georgia, serif;
  font-size: 36px;
  font-weight: 900;
  letter-spacing: -0.02em;
  line-height: 1;
  color: var(--ink);
}

.pub-name em {
  color: var(--accent);
  font-style: normal;
}

.masthead-meta {
  text-align: center;
}

.masthead-meta .edition {
  font-family: 'JetBrains Mono', monospace;
  font-size: 9px;
  text-transform: uppercase;
  letter-spacing: 0.2em;
  color: var(--ink-dim);
  display: block;
  margin-bottom: 4px;
}

.masthead-meta .date-line {
  font-family: 'Crimson Pro', serif;
  font-size: 13px;
  font-style: italic;
  color: var(--ink-mid);
}

.masthead-actions {
  display: flex;
  gap: 10px;
  align-items: center;
}

.btn-primary {
  background: var(--ink);
  color: var(--bg);
  border: none;
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  padding: 9px 18px;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 8px;
}

.btn-primary:hover { background: var(--accent); }
.btn-primary:disabled { opacity:0.4; pointer-events:none; }

.btn-secondary {
  background: transparent;
  color: var(--ink);
  border: 1px solid var(--rule);
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  padding: 8px 16px;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 8px;
}

.btn-secondary:hover { border-color: var(--ink); }

/* Filter nav */
.masthead-nav {
  display: flex;
  align-items: center;
  gap: 0;
  padding: 10px 0;
  overflow-x: auto;
}

.nav-item {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  padding: 5px 18px;
  border: none;
  background: transparent;
  color: var(--ink-dim);
  cursor: pointer;
  transition: all 0.15s;
  white-space: nowrap;
  border-right: 1px solid var(--rule);
  position: relative;
}

.nav-item:first-child { padding-left: 0; }
.nav-item:last-child { border-right: none; }

.nav-item:hover { color: var(--ink); }
.nav-item.active { color: var(--ink); font-weight: 700; }

.nav-item.active::after {
  content: '';
  position: absolute;
  bottom: -10px;
  left: 0; right: 0;
  height: 3px;
  background: var(--accent);
}

/* Ticker */
.ticker {
  background: var(--ink);
  color: var(--bg);
  padding: 0;
  height: 28px;
  display: flex;
  align-items: center;
  overflow: hidden;
}

.ticker-label {
  font-family: 'JetBrains Mono', monospace;
  font-size: 9px;
  text-transform: uppercase;
  letter-spacing: 0.15em;
  background: var(--accent);
  color: white;
  padding: 0 14px;
  height: 100%;
  display: flex;
  align-items: center;
  flex-shrink: 0;
  white-space: nowrap;
}

.ticker-track { overflow: hidden; flex: 1; }
.ticker-inner {
  display: flex;
  animation: ticker-scroll 60s linear infinite;
  white-space: nowrap;
}

.ticker-item {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  letter-spacing: 0.04em;
  padding: 0 40px;
  color: rgba(245,242,235,0.75);
}

.ticker-item strong { color: var(--bg); font-weight: 500; }

@keyframes ticker-scroll {
  0% { transform: translateX(0); }
  100% { transform: translateX(-50%); }
}

/* â”€â”€ LAYOUT â”€â”€ */
.page {
  position: relative; z-index: 1;
  max-width: 1440px;
  margin: 0 auto;
  padding: 0 48px 60px;
  display: grid;
  grid-template-columns: 1fr 300px;
  grid-template-rows: auto 1fr;
  gap: 0 40px;
}

/* â”€â”€ HERO STORY â”€â”€ */
.hero-strip {
  grid-column: 1 / -1;
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 0;
  border-bottom: 2px solid var(--ink);
  margin-bottom: 32px;
  padding: 28px 0;
}

.hero-story {
  padding: 0 28px;
  border-right: 1px solid var(--rule);
  cursor: pointer;
  transition: all 0.2s;
}

.hero-story:first-child { padding-left: 0; }
.hero-story:last-child { border-right: none; }
.hero-story:hover { opacity: 0.8; }

.hero-kicker {
  font-family: 'JetBrains Mono', monospace;
  font-size: 9px;
  text-transform: uppercase;
  letter-spacing: 0.18em;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.hero-headline {
  font-family: 'Playfair Display', serif;
  font-size: 20px;
  font-weight: 700;
  line-height: 1.3;
  margin-bottom: 10px;
  color: var(--ink);
}

.hero-deck {
  font-family: 'Crimson Pro', serif;
  font-size: 14px;
  color: var(--ink-mid);
  line-height: 1.6;
  font-weight: 300;
}

/* â”€â”€ MAIN FEED â”€â”€ */
.feed-section { padding-top: 0; }

.section-rule {
  display: flex;
  align-items: center;
  gap: 16px;
  margin-bottom: 20px;
}

.section-rule h2 {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.2em;
  color: var(--ink-dim);
  white-space: nowrap;
}

.rule-line {
  flex: 1;
  height: 1px;
  background: var(--rule);
}

.article {
  display: grid;
  grid-template-columns: 1fr auto;
  gap: 16px;
  padding: 20px 0;
  border-bottom: 1px solid var(--rule);
  cursor: pointer;
  transition: opacity 0.15s;
  animation: slideIn 0.3s ease forwards;
  opacity: 0;
}

@keyframes slideIn {
  from { opacity:0; transform: translateY(8px); }
  to { opacity:1; transform: translateY(0); }
}

.article:hover { opacity: 0.75; }
.article:hover .article-headline { text-decoration: underline; text-underline-offset: 3px; }
.article:last-child { border-bottom: none; }

.article-left {}

.article-kicker {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 7px;
}

.sector-pill {
  font-family: 'JetBrains Mono', monospace;
  font-size: 9px;
  text-transform: uppercase;
  letter-spacing: 0.14em;
  padding: 2px 8px;
  border-left: 3px solid currentColor;
  background: transparent;
}

.sector-pill.PE { color: var(--pe-c); background: rgba(196,56,26,0.06); }
.sector-pill.Credit { color: var(--credit-c); background: rgba(26,74,138,0.06); }
.sector-pill.Infra { color: var(--infra-c); background: rgba(42,106,58,0.06); }
.sector-pill.RE { color: var(--re-c); background: rgba(122,58,26,0.06); }
.sector-pill.Hedge { color: var(--hedge-c); background: rgba(74,26,122,0.06); }
.sector-pill.Macro { color: var(--macro-c); background: rgba(26,90,106,0.06); }

.article-source {
  font-family: 'JetBrains Mono', monospace;
  font-size: 9px;
  color: var(--ink-dim);
  text-transform: uppercase;
  letter-spacing: 0.1em;
}

.article-time {
  font-family: 'JetBrains Mono', monospace;
  font-size: 9px;
  color: var(--ink-dim);
}

.article-headline {
  font-family: 'Playfair Display', serif;
  font-size: 17px;
  font-weight: 700;
  line-height: 1.35;
  margin-bottom: 8px;
  color: var(--ink);
}

.article-body {
  font-family: 'Crimson Pro', serif;
  font-size: 15px;
  color: var(--ink-mid);
  line-height: 1.65;
  font-weight: 300;
  margin-bottom: 10px;
}

/* AI Summary */
.ai-summary-wrap {
  margin-top: 10px;
  padding: 12px 14px;
  background: rgba(26,74,138,0.04);
  border-left: 3px solid var(--accent2);
}

.ai-label {
  font-family: 'JetBrains Mono', monospace;
  font-size: 9px;
  text-transform: uppercase;
  letter-spacing: 0.15em;
  color: var(--accent2);
  margin-bottom: 6px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.ai-text {
  font-family: 'Crimson Pro', serif;
  font-size: 14px;
  color: var(--ink-mid);
  line-height: 1.65;
  font-weight: 300;
  font-style: italic;
}

.typing-cursor {
  display: inline-block;
  width: 2px; height: 14px;
  background: var(--accent2);
  animation: blink 0.8s steps(1) infinite;
  vertical-align: middle;
  margin-right: 2px;
}
@keyframes blink { 50% { opacity:0; } }

.article-actions {
  display: flex;
  align-items: center;
  gap: 14px;
  margin-top: 6px;
}

.action-btn {
  font-family: 'JetBrains Mono', monospace;
  font-size: 9px;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  background: transparent;
  border: 1px solid var(--rule);
  color: var(--ink-mid);
  padding: 5px 12px;
  cursor: pointer;
  transition: all 0.15s;
  display: flex; align-items: center; gap: 6px;
}

.action-btn:hover { border-color: var(--ink-mid); color: var(--ink); }
.action-btn.summarized { border-color: var(--accent2); color: var(--accent2); }
.action-btn:disabled { opacity: 0.35; pointer-events: none; }

.read-more {
  font-family: 'JetBrains Mono', monospace;
  font-size: 9px;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--ink-dim);
  text-decoration: none;
  transition: color 0.15s;
  margin-right: auto;
}
.read-more:hover { color: var(--accent); }

.paywall-badge {
  font-family: 'JetBrains Mono', monospace;
  font-size: 8px;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--ink-dim);
  border: 1px solid var(--rule);
  padding: 2px 6px;
  opacity: 0.6;
}

/* Relevance */
.rel-score {
  font-family: 'JetBrains Mono', monospace;
  font-size: 9px;
  color: var(--ink-dim);
  display: flex;
  align-items: center;
  gap: 6px;
}

.rel-dots {
  display: flex; gap: 2px;
}

.rel-dot {
  width: 5px; height: 5px; border-radius: 50%;
  background: var(--rule);
}
.rel-dot.filled { background: var(--gold); }

/* Article right col */
.article-right {
  width: 80px;
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 8px;
  padding-top: 4px;
  flex-shrink: 0;
}

.big-number {
  font-family: 'Playfair Display', serif;
  font-size: 42px;
  font-weight: 900;
  line-height: 1;
  color: var(--bg2);
  letter-spacing: -0.03em;
  user-select: none;
}

/* â”€â”€ SIDEBAR â”€â”€ */
.sidebar {
  border-left: 1px solid var(--rule);
  padding-left: 28px;
  padding-top: 0;
}

.sidebar-widget {
  margin-bottom: 32px;
  padding-bottom: 28px;
  border-bottom: 1px solid var(--rule);
}

.sidebar-widget:last-child { border-bottom: none; }

.widget-head {
  font-family: 'JetBrains Mono', monospace;
  font-size: 9px;
  text-transform: uppercase;
  letter-spacing: 0.2em;
  color: var(--ink-dim);
  margin-bottom: 16px;
  padding-bottom: 10px;
  border-bottom: 2px solid var(--ink);
  display: flex;
  align-items: center;
  justify-content: space-between;
}

/* Daily Briefing widget */
.briefing-widget {
  background: var(--ink);
  color: var(--bg);
  padding: 18px;
  margin-bottom: 28px;
}

.briefing-head {
  font-family: 'JetBrains Mono', monospace;
  font-size: 9px;
  text-transform: uppercase;
  letter-spacing: 0.2em;
  color: rgba(245,242,235,0.5);
  margin-bottom: 12px;
  padding-bottom: 10px;
  border-bottom: 1px solid rgba(245,242,235,0.15);
  display: flex; align-items: center; gap: 8px;
}

.briefing-head::before {
  content: 'â˜…';
  color: var(--gold);
  font-size: 10px;
}

.briefing-body {
  font-family: 'Crimson Pro', serif;
  font-size: 14px;
  line-height: 1.7;
  color: rgba(245,242,235,0.75);
  font-weight: 300;
  min-height: 80px;
}

.briefing-body p { margin-bottom: 10px; }
.briefing-body p:last-child { margin-bottom: 0; }

.briefing-placeholder {
  font-style: italic;
  color: rgba(245,242,235,0.35);
  font-size: 13px;
}

.briefing-actions {
  display: flex;
  gap: 8px;
  margin-top: 14px;
  padding-top: 12px;
  border-top: 1px solid rgba(245,242,235,0.15);
}

.btn-briefing {
  flex: 1;
  background: var(--accent);
  color: white;
  border: none;
  font-family: 'JetBrains Mono', monospace;
  font-size: 9px;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  padding: 9px 10px;
  cursor: pointer;
  transition: all 0.2s;
  display: flex; align-items: center; justify-content: center; gap: 6px;
}

.btn-briefing:hover { background: #a02e14; }
.btn-briefing:disabled { opacity:0.4; pointer-events:none; }

.btn-email {
  flex: 1;
  background: transparent;
  color: rgba(245,242,235,0.6);
  border: 1px solid rgba(245,242,235,0.2);
  font-family: 'JetBrains Mono', monospace;
  font-size: 9px;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  padding: 9px 10px;
  cursor: pointer;
  transition: all 0.2s;
  display: flex; align-items: center; justify-content: center; gap: 6px;
}

.btn-email:hover { border-color: rgba(245,242,235,0.5); color: rgba(245,242,235,0.85); }
.btn-email:disabled { opacity: 0.4; pointer-events: none; }

/* Sector stats */
.sector-stat {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
  font-size: 13px;
}

.stat-name {
  font-family: 'JetBrains Mono', monospace;
  font-size: 9px;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  width: 54px;
  flex-shrink: 0;
}

.stat-bar {
  flex: 1; height: 3px;
  background: var(--bg2);
}

.stat-fill {
  height: 100%;
  transition: width 0.6s ease;
}

.stat-n {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  color: var(--ink-dim);
  width: 18px;
  text-align: right;
}

/* Sources */
.source-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 0;
  border-bottom: 1px solid var(--rule);
}

.source-row:last-child { border-bottom: none; }

.source-n { font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--ink); }
.source-label { font-family: 'JetBrains Mono', monospace; font-size: 9px; text-transform: uppercase; letter-spacing: 0.1em; color: var(--ink-mid); }
.source-status-dot { width: 6px; height: 6px; border-radius: 50%; }
.source-status-dot.on { background: var(--infra-c); }
.source-status-dot.off { background: var(--rule); }

/* Email modal */
.modal-overlay {
  position: fixed; inset: 0;
  background: rgba(26,22,18,0.75);
  z-index: 1000;
  display: flex; align-items: center; justify-content: center;
  opacity: 0; pointer-events: none;
  transition: opacity 0.2s;
}

.modal-overlay.open { opacity:1; pointer-events:all; }

.modal {
  background: var(--surface);
  border: 1px solid var(--rule);
  padding: 40px 48px;
  max-width: 620px;
  width: 90%;
  transform: translateY(20px);
  transition: transform 0.3s ease;
}

.modal-overlay.open .modal { transform: translateY(0); }

.modal-kicker {
  font-family: 'JetBrains Mono', monospace;
  font-size: 9px;
  text-transform: uppercase;
  letter-spacing: 0.2em;
  color: var(--ink-dim);
  margin-bottom: 8px;
}

.modal-title {
  font-family: 'Playfair Display', serif;
  font-size: 26px;
  font-weight: 700;
  margin-bottom: 16px;
  line-height: 1.2;
}

.modal-title em { color: var(--accent); font-style: normal; }

.modal-divider { height: 1px; background: var(--rule); margin: 20px 0; }

.email-preview {
  background: var(--bg);
  border: 1px solid var(--rule);
  padding: 24px 28px;
  margin-bottom: 20px;
}

.email-from {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  color: var(--ink-dim);
  margin-bottom: 4px;
}

.email-subject {
  font-family: 'Playfair Display', serif;
  font-size: 16px;
  font-weight: 700;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 1px solid var(--rule);
}

.email-body-preview {
  font-family: 'Crimson Pro', serif;
  font-size: 14px;
  color: var(--ink-mid);
  line-height: 1.7;
  font-weight: 300;
}

.modal-form {
  display: flex;
  gap: 10px;
  margin-bottom: 12px;
}

.modal-input {
  flex: 1;
  border: 1px solid var(--rule);
  background: var(--bg);
  font-family: 'JetBrains Mono', monospace;
  font-size: 12px;
  padding: 10px 14px;
  color: var(--ink);
  outline: none;
  transition: border-color 0.2s;
}

.modal-input:focus { border-color: var(--ink); }

.modal-time {
  font-family: 'JetBrains Mono', monospace;
  font-size: 9px;
  color: var(--ink-dim);
  margin-top: 6px;
  text-transform: uppercase;
  letter-spacing: 0.1em;
}

.modal-close {
  position: absolute;
  top: 16px; right: 20px;
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  background: none; border: none;
  cursor: pointer;
  color: var(--ink-dim);
  text-transform: uppercase;
  letter-spacing: 0.1em;
}

.modal { position: relative; }

.success-msg {
  display: none;
  text-align: center;
  padding: 20px;
}

.success-msg.show { display: block; }

.success-msg h3 {
  font-family: 'Playfair Display', serif;
  font-size: 22px;
  margin-bottom: 8px;
}

.success-msg p {
  font-family: 'Crimson Pro', serif;
  color: var(--ink-mid);
  font-size: 15px;
}

/* Spinning icon */
.spin { animation: spin 1.2s linear infinite; display:inline-block; }
@keyframes spin { to { transform: rotate(360deg); } }

/* Skeleton */
.skel { background: linear-gradient(90deg, var(--bg2) 25%, #e8e3d8 50%, var(--bg2) 75%); background-size: 400%; animation: shimmer 1.5s infinite; border-radius: 2px; }
@keyframes shimmer { 0% { background-position:100% 0; } 100% { background-position:-100% 0; } }

::-webkit-scrollbar { height: 3px; width: 3px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: var(--rule); }

@media (max-width: 960px) {
  .page { grid-template-columns: 1fr; padding: 0 20px 40px; }
  .sidebar { border-left: none; border-top: 2px solid var(--ink); padding-left: 0; padding-top: 28px; }
  .hero-strip { grid-template-columns: 1fr; gap: 20px; }
  .hero-story { border-right: none; border-bottom: 1px solid var(--rule); padding: 0 0 20px; }
  .masthead { padding: 0 20px; }
}
</style>
</head>
<body>

<!-- Masthead -->
<header class="masthead">
  <div class="masthead-top">
    <div class="pub-name">ALT<em>Â·</em>INTEL</div>
    <div class="masthead-meta">
      <span class="edition">Private Markets Intelligence</span>
      <span class="date-line" id="current-date">Loading...</span>
    </div>
    <div class="masthead-actions">
      <button class="btn-secondary" onclick="loadFeed()">
        <svg id="refresh-ico" width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 12a9 9 0 11-6.219-8.56"/></svg>
        Refresh
      </button>
      <button class="btn-primary" onclick="openEmailModal()">
        âœ‰ Subscribe Daily
      </button>
    </div>
  </div>
  <nav class="masthead-nav">
    <button class="nav-item" id="btn-live" data-s="live" onclick="filter('live',this)">Live Briefing</button>
    <button class="nav-item" id="btn-all" data-s="all" onclick="filter('all',this)">All Sectors</button>
    <button class="nav-item" data-s="PE" onclick="filter('PE',this)">Private Equity</button>
    <button class="nav-item" data-s="Credit" onclick="filter('Credit',this)">Private Credit</button>
    <button class="nav-item" data-s="Infra" onclick="filter('Infra',this)">Infrastructure</button>
    <button class="nav-item" data-s="RE" onclick="filter('RE',this)">Real Estate</button>
    <button class="nav-item" data-s="Hedge" onclick="filter('Hedge',this)">Hedge Funds</button>
    <button class="nav-item" data-s="Macro" onclick="filter('Macro',this)">Macro</button>
  </nav>
</header>

<!-- Ticker -->
<div class="ticker">
  <div class="ticker-label">BREAKING</div>
  <div class="ticker-track">
    <div class="ticker-inner" id="ticker-inner">
      <span class="ticker-item"><strong>KKR</strong> closes $20B flagship fund, surpassing $18B target</span>
      <span class="ticker-item"><strong>FED</strong> officials signal caution on rate cuts â€” PE valuations under pressure</span>
      <span class="ticker-item"><strong>BROOKFIELD</strong> acquires Australian energy assets for $4.5B</span>
      <span class="ticker-item"><strong>APOLLO</strong> raises $15B for credit strategies fund</span>
      <span class="ticker-item"><strong>BLACKSTONE</strong> reports 14% AUM growth in Q1 â€” real estate drag persists</span>
      <span class="ticker-item"><strong>PRIVATE CREDIT</strong> spreads tighten 45bps YTD as institutional demand surges</span>
      <span class="ticker-item"><strong>CARLYLE</strong> eyes â‚¬7.5B European healthcare buyout</span>
      <span class="ticker-item"><strong>MULTI-STRATEGY</strong> hedge funds post best Q1 returns since 2020</span>
      <!-- dup -->
      <span class="ticker-item"><strong>KKR</strong> closes $20B flagship fund, surpassing $18B target</span>
      <span class="ticker-item"><strong>FED</strong> officials signal caution on rate cuts â€” PE valuations under pressure</span>
      <span class="ticker-item"><strong>BROOKFIELD</strong> acquires Australian energy assets for $4.5B</span>
      <span class="ticker-item"><strong>APOLLO</strong> raises $15B for credit strategies fund</span>
      <span class="ticker-item"><strong>BLACKSTONE</strong> reports 14% AUM growth in Q1 â€” real estate drag persists</span>
      <span class="ticker-item"><strong>PRIVATE CREDIT</strong> spreads tighten 45bps YTD as institutional demand surges</span>
      <span class="ticker-item"><strong>CARLYLE</strong> eyes â‚¬7.5B European healthcare buyout</span>
      <span class="ticker-item"><strong>MULTI-STRATEGY</strong> hedge funds post best Q1 returns since 2020</span>
    </div>
  </div>
</div>

<!-- Page -->
<div class="page">

  <!-- Hero strip -->
  <div class="hero-strip" id="hero-strip">
    <!-- injected by JS -->
  </div>

  <!-- Feed -->
  <div class="feed-section">
    <div class="section-rule">
      <h2>Latest Intelligence</h2>
      <div class="rule-line"></div>
      <span style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--ink-dim);white-space:nowrap;" id="feed-count">â€” 0 articles</span>
    </div>
    <div id="feed-container"></div>
  </div>

  <!-- Sidebar -->
  <aside class="sidebar">

    <!-- Daily Briefing -->
    <div class="briefing-widget">
      <div class="briefing-head">Morning Briefing â€” AI Generated</div>
      <div class="briefing-body" id="briefing-body">
        <span class="briefing-placeholder">AI features require a server-side proxy (API key cannot run in the browser). News feed works normally.</span>
      </div>
      <div class="briefing-actions">
        <button class="btn-briefing" id="gen-btn" onclick="generateBriefing()">âš¡ Generate</button>
        <button class="btn-email" id="email-brief-btn" onclick="openEmailModal()" disabled>âœ‰ Email</button>
      </div>
    </div>

    <!-- Sector breakdown -->
    <div class="sidebar-widget">
      <div class="widget-head">
        <span>Sector Distribution</span>
        <span id="total-articles" style="color:var(--ink)">0</span>
      </div>
      <div id="sector-stats"></div>
    </div>

    <!-- Sources -->
    <div class="sidebar-widget">
      <div class="widget-head">Data Sources</div>
      <div id="sources-widget"></div>
    </div>

  </aside>
</div>

<!-- Email Modal -->
<div class="modal-overlay" id="email-modal" onclick="closeModalOutside(event)">
  <div class="modal">
    <button class="modal-close" onclick="closeEmailModal()">âœ• Close</button>
    <div class="modal-kicker">Daily Briefing Delivery</div>
    <div class="modal-title">Subscribe to <em>ALTÂ·Intel</em></div>
    <p style="font-family:'Crimson Pro',serif;font-size:15px;color:var(--ink-mid);line-height:1.65;margin-bottom:16px;">Receive a personalized AI-generated briefing on private markets news every morning at 7:00 AM.</p>
    <div class="modal-divider"></div>

    <div id="email-preview-section">
      <!-- Email preview -->
      <div class="email-preview">
        <div class="email-from">From: <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="90f2e2f9f5f6f9fef7d0f1fce4bdf9fee4f5fcbef3fffd">[email&#160;protected]</a> Â· To: you</div>
        <div class="email-subject" id="email-subject-preview">ALTÂ·Intel Morning Briefing â€” Thu, Feb 20, 2025</div>
        <div class="email-body-preview" id="email-body-preview">
          <em style="color:var(--ink-dim);font-size:13px;">Generate a briefing first to preview your email content...</em>
        </div>
      </div>

      <div class="modal-form">
        <input class="modal-input" type="email" id="email-input" placeholder="your@email.com" />
        <button class="btn-primary" id="subscribe-btn" onclick="subscribe()">Subscribe</button>
      </div>
      <div class="modal-time">ðŸ“… Delivered daily at 07:00 AM Â· Unsubscribe anytime</div>
    </div>

    <div class="success-msg" id="success-msg">
      <h3>You're subscribed.</h3>
      <p>Your first briefing will arrive tomorrow morning at 7:00 AM.</p>
    </div>
  </div>
</div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DATA
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CONFIG
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RSS FEEDS â€” real articles, no backend needed
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const RSS_FEEDS = [
  // â”€â”€ Paywall â€” ×›×•×ª×¨×•×ª + ×œ×™× ×§ ×œ××ª×¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  { url: "https://www.privateequitywire.co.uk/feed/",                                  source: "PE Wire",        sector: "PE",     paywall: true  },
  { url: "https://www.infrastructureinvestor.com/feed/",                               source: "Infra Investor", sector: "Infra",  paywall: true  },
  { url: "https://www.perenews.com/feed/",                                             source: "PERE News",      sector: "RE",     paywall: true  },
  { url: "https://www.buyoutsinsider.com/feed/",                                       source: "Buyouts Insider",sector: "PE",     paywall: true  },
  { url: "https://www.privateequityinternational.com/feed/",                           source: "PEI",            sector: "PE",     paywall: true  },
  { url: "https://feeds.content.dowjones.io/public/rss/RSSMarketsMain",               source: "WSJ Markets",    sector: "Macro",  paywall: true  },
  { url: "https://feeds.content.dowjones.io/public/rss/WSJcomUSBusiness",             source: "WSJ Business",   sector: "PE",     paywall: true  },
  { url: "https://www.ft.com/stream/ab70c42c-4d60-4851-89bb-16e2daeddfc1?format=rss", source: "FT Private Equity", sector: "PE",  paywall: true  },
  { url: "https://www.fnlondon.com/rss",                                               source: "FN London",      sector: "Hedge",  paywall: true  },
  { url: "https://unquote.com/feeds/rss",                                              source: "Unquote",        sector: "PE",     paywall: true  },

  // â”€â”€ ×¤×ª×•×— â€” ×§×¨×™××” ×ž×œ××” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  { url: "https://feeds.reuters.com/reuters/businessNews",                             source: "Reuters",        sector: "Macro",  paywall: false },
  { url: "https://www.cnbc.com/id/10001147/device/rss/rss.html",                      source: "CNBC",           sector: "Macro",  paywall: false },
  { url: "https://altassets.net/feed",                                                 source: "AltAssets",      sector: "PE",     paywall: false },
  { url: "https://pitchbook.com/blog/rss.xml",                                         source: "PitchBook",      sector: "PE",     paywall: false },
  { url: "https://corpgov.law.harvard.edu/feed/",                                      source: "Harvard Law",    sector: "PE",     paywall: false },
  { url: "https://opalesque.com/rss.xml",                                              source: "Opalesque",      sector: "Hedge",  paywall: false },
  { url: "https://news.google.com/rss/search?q=preqin+alternatives&hl=en-US&gl=US&ceid=US:en", source: "Preqin News", sector: "PE", paywall: false },
  { url: "https://news.google.com/rss/search?q=pitchbook+private+equity+deal&hl=en-US&gl=US&ceid=US:en", source: "PitchBook News", sector: "PE", paywall: false },

  // â”€â”€ Curated Google News (captures Bloomberg/FT/Reuters/etc when alternatives-relevant) â”€â”€
  { url: "https://news.google.com/rss/search?q=site%3Abloomberg.com+(%22private+equity%22+OR+%22private+credit%22+OR+secondaries+OR+%22continuation+fund%22+OR+%22NAV+loan%22+OR+fundraising)&hl=en-US&gl=US&ceid=US:en", source: "Google (Bloomberg)", sector: "Macro", paywall: true },
  { url: "https://news.google.com/rss/search?q=site%3Aft.com+(%22private+equity%22+OR+%22private+credit%22+OR+secondaries+OR+%22continuation+fund%22+OR+fundraising)&hl=en-US&gl=US&ceid=US:en", source: "Google (FT)", sector: "Macro", paywall: true },
  { url: "https://news.google.com/rss/search?q=site%3Areuters.com+(%22private+equity%22+OR+%22private+credit%22+OR+secondaries+OR+%22continuation+fund%22+OR+fundraising)&hl=en-US&gl=US&ceid=US:en", source: "Google (Reuters)", sector: "Macro", paywall: false },

  // â”€â”€ Research brands via Google News (when they publish / are cited) â”€â”€
  { url: "https://news.google.com/rss/search?q=pitchbook+(private+equity+OR+private+credit+OR+secondaries+OR+fundraising)&hl=en-US&gl=US&ceid=US:en", source: "Google (PitchBook)", sector: "PE", paywall: false },
  { url: "https://news.google.com/rss/search?q=preqin+(private+markets+OR+alternatives+OR+private+equity+OR+private+credit)&hl=en-US&gl=US&ceid=US:en", source: "Google (Preqin)", sector: "PE", paywall: false },
  { url: "https://news.google.com/rss/search?q=%22Cambridge+Associates%22+(alternatives+OR+private+equity+OR+private+credit)&hl=en-US&gl=US&ceid=US:en", source: "Google (Cambridge)", sector: "Macro", paywall: false },
  { url: "https://businesswire.com/rss/home/rss_homepage.rss",                        source: "Business Wire",  sector: "PE",     paywall: false },
  { url: "https://www.theguardian.com/business/privateequity/rss",                    source: "The Guardian PE",sector: "PE",     paywall: false },
];

const RSS2JSON = 'https://api.rss2json.com/v1/api.json?rss_url='; // legacy (may fail)
const RAW_PROXY = 'https://api.allorigins.win/raw?url=';
const JINA_PROXY_HTTP = 'https://r.jina.ai/http://';
const JINA_PROXY_HTTPS = 'https://r.jina.ai/https://';


// Time window filter (last N days)
const MAX_DAYS = 30;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Investor Briefing mode
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const BRIEFING_MODE = true;                // Live filtered feed + daily brief
const QUALITY_THRESHOLD_LIVE = 60;         // show only strong signals in Live view
const LIVE_MAX_ITEMS = 12;                 // cap Live view
const DAILY_BRIEF_HOUR_LOCAL = 9;          // auto-generate after 09:00 local time
const DAILY_BRIEF_MAX_ITEMS = 8;           // number of stories in daily brief

// Source tiers (tune as needed)
const TIER1 = [
  'Financial Times','FT','Reuters','Bloomberg','PEI','Private Equity International',
  'Secondaries Investor','Infrastructure Investor','Real Estate Capital',
  'PE Wire','Private Equity Wire','Buyouts','PitchBook'
];
const TIER2 = [
  'Institutional Investor','Unquote','AltAssets','PE Hub','WSJ','Wall Street Journal',
  'The Economist','Fortune','Axios'
];

// High-signal / low-signal language
const HIGH_SIGNAL_RE = /(first close|final close|hard cap|fundraise|raised|closing|close[d]? on|take-?private|lbo|acquir|sale|divest|ipo|continuation|gp-led|secondaries|nav (loan|facility)|subscription line|refinanc|redemption|gate|liquidity|distress|default|restructur|leverage|unitranche|direct lending|private credit|aum|ir{2}|tvpi|dpi|valuation|multiple)/i;
const LOW_SIGNAL_RE  = /(podcast|sponsored|advertis|webinar|catch up|opinion|substack|newsletter only)/i;

// Basic theme classifier for Daily Brief
function classifyTheme(a) {
  const t = ((a.title||'') + ' ' + (a.body||'')).toLowerCase();
  if (/(redemption|gate|liquidity|default|distress|restructur)/i.test(t)) return 'Liquidity / Stress';
  if (/(fundraise|first close|final close|hard cap|close[d]? on|raised)/i.test(t)) return 'Fundraising';
  if (/(nav (loan|facility)|subscription line|direct lending|private credit|unitranche|leveraged loan)/i.test(t)) return 'Credit / Financing';
  if (/(take-?private|lbo|acquir|sale|divest|ipo|merger|m&a)/i.test(t)) return 'Transactions';
  if (/(gp stakes|stake sale|minority stake|gp-led|continuation|secondaries)/i.test(t)) return 'Secondaries / GP Stakes';
  if (/(ai|artificial intelligence|data center|datacenter)/i.test(t)) return 'AI Impact';
  return 'Market';
}

function sourceTierScore(source) {
  const s = (source || '').toLowerCase();
  if (TIER1.some(x => s.includes(x.toLowerCase()))) return 30;
  if (TIER2.some(x => s.includes(x.toLowerCase()))) return 20;
  if (s.includes('google')) return 6;
  return 12;
}

function qualityScore(a) {
  const text = ((a.title||'') + ' ' + (a.body||'')).toLowerCase();
  let score = 10;
  score += sourceTierScore(a.source);
  if (HIGH_SIGNAL_RE.test(text)) score += 30;
  if (LOW_SIGNAL_RE.test(text)) score -= 20;

  // Sector hints
  if (a.sector === 'PE') score += 4;
  if (a.sector === 'Credit') score += 4;
  if (a.sector === 'Infra' || a.sector === 'RE') score += 2;

  // Freshness bonus (within 24h)
  if (a._ts && (Date.now() - a._ts) <= 24*60*60*1000) score += 6;

  // Paywall penalty if there are alternatives in dedup (handled elsewhere), mild here
  if (a.paywall) score -= 3;

  return Math.max(0, Math.min(100, score));
}
const AI_ENABLED = true; // requires proxy
const API_BASE = ""; // set to proxy base URL, e.g. https://your-proxy


function isWithinTimeWindow(pubDate) {
  if (!pubDate) return false;
  const t = new Date(pubDate).getTime();
  if (!isFinite(t)) return false;
  const diff = Date.now() - t;
  return diff <= MAX_DAYS * 24 * 60 * 60 * 1000;
}

// Keyword-based sector guesser
const SECTOR_KEYWORDS = {
  PE:     ["private equity","buyout","lbo","kkr","carlyle","blackstone","apollo","eqt","warburg","advent","bain capital"],
  Credit: ["private credit","direct lending","credit fund","private debt","leveraged loan","ares","blue owl","golub"],
  Infra:  ["infrastructure","infrastructure investor","infra fund","infrastructure fund","renewable","renewables","energy transition","solar","wind","battery","storage","grid","transmission","utility","utilities","digital infrastructure","data center","datacenter","fiber","fibre","tower","towers","airport","ports","port","toll road","rail","railway","pipeline","lng","terminal","brookfield","macquarie","ifm","global infrastructure partners","gip","kkr infrastructure","stonepeak"],
  RE:     ["real estate","property","reit","repe","real estate private equity","commercial property","commercial real estate","cre","office","offices","logistics","warehouse","industrial","multifamily","residential","housing","student housing","senior housing","build-to-rent","btr","hotel","hospitality","self storage","self-storage","storage reit","data center real estate","life sciences real estate","blackstone real estate","brookfield real estate","kkr real estate"],
  Hedge:  ["hedge fund","long/short","multi-strategy","macro fund","bridgewater","citadel","millennium"],
  Macro:  ["interest rate","federal reserve","fed","inflation","gdp","central bank","ecb","monetary","pension","sovereign wealth"],
};
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ALT-ONLY FILTER (sector-aware, Infra/RE friendly)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const FILTER_MODE = 'smart'; // 'off' | 'smart'

const EXCLUDE_NOISE = [
  "crypto","bitcoin","ethereum","meme stock","sports betting","celebrity","fashion",
  "iphone","android","retail trading","day trading","earnings call"
];

// Broad but still "alts" oriented
const ALT_CORE = [
  "private markets","alternative investments","alternatives",
  "private equity","buyout","lbo","gp","lp","limited partner","general partner",
  "fundraising","first close","final close","hard cap","second close",
  "private credit","direct lending","private debt","special situations",
  "secondaries","secondary","gp-led","continuation fund",
  "nav loan","nav facility","subscription line",
  "infrastructure fund","real estate fund","repe","hedge fund"
];

// Relaxed dictionaries for Infra/RE so they don't get filtered out
const INFRA_RELAX = [
  "infrastructure","renewable","energy transition","solar","wind","battery","grid","utility",
  "digital infrastructure","data center","datacenter","fiber","fibre","tower","airport","port","toll road","rail","pipeline","lng"
];

const RE_RELAX = [
  "real estate","property","reit","commercial real estate","cre","logistics","warehouse",
  "multifamily","housing","student housing","self storage","self-storage","hospitality","office"
];

// If the source is already a niche alts outlet, be lenient
const TRUSTED_ALTS_SOURCES = [
  "PE Wire","Infra Investor","Infrastructure Investor","PERE","PERE News","PEI","Unquote","Buyouts Insider",
  "AltAssets","PitchBook","Opalesque","Harvard Law","Institutional Investor","Global SWF","Alternative Credit Investor"
];

function textHasAny(t, arr) {
  return arr.some(k => t.includes(k));
}

function isAltRelevant(item) {
  const t = ((item.title || "") + " " + (item.body || "")).toLowerCase();

  // kill obvious noise early
  if (textHasAny(t, EXCLUDE_NOISE)) return false;

  const isTrusted = TRUSTED_ALTS_SOURCES.some(s => (item.source || "").toLowerCase().includes(s.toLowerCase()));

  if (item.sector === "Infra") {
    return isTrusted || textHasAny(t, INFRA_RELAX) || textHasAny(t, ALT_CORE);
  }

  if (item.sector === "RE") {
    return isTrusted || textHasAny(t, RE_RELAX) || textHasAny(t, ALT_CORE);
  }

  // PE/Credit/Hedge/Macro: stricter
  return isTrusted || textHasAny(t, ALT_CORE);
}

// Alt-markets allowlist filter (to keep feed strictly alternatives) 
function guessSector(title, body, defaultSector) {
  const text = (title + " " + body).toLowerCase();

  const hasWord = (w) => new RegExp(`\\b${w.replace(/[-/\\^$*+?.()|[\\]{}]/g, '\\$&')}\\b`, 'i').test(text);

  // â”€â”€ HARD OVERRIDES (most specific first) â”€â”€

  // Credit (do this BEFORE RE to avoid false positives like "Breit" matching "reit")
  if (
    text.includes("private credit") ||
    text.includes("direct lending") ||
    text.includes("private debt") ||
    text.includes("leveraged loan") ||
    text.includes("unitranche") ||
    text.includes("mezzanine") ||
    text.includes("bdc") ||
    (text.includes("credit") && (text.includes("spreads") || text.includes("lending") || text.includes("loan")))
  ) return "Credit";

  // Infrastructure
  if (
    text.includes("infrastructure") ||
    text.includes("digital infrastructure") ||
    text.includes("transport infra") ||
    text.includes("infra fund") ||
    (hasWord("infra") && text.includes("fund")) ||
    text.includes("data center") ||
    text.includes("datacenter") ||
    text.includes("renewable") ||
    text.includes("energy transition") ||
    text.includes("toll road") ||
    text.includes("airport") ||
    text.includes("port") ||
    text.includes("pipeline") ||
    text.includes("grid")
  ) return "Infra";

  // Real Estate (word-boundary checks for short tokens)
  if (
    text.includes("real estate") ||
    text.includes("commercial real estate") ||
    text.includes("property") ||
    hasWord("reit") ||
    hasWord("repe") ||
    text.includes("multifamily") ||
    text.includes("logistics") ||
    text.includes("warehouse") ||
    text.includes("office market") ||
    text.includes("student housing") ||
    text.includes("self storage") ||
    text.includes("hospitality")
  ) return "RE";

  // Otherwise: keyword scoring across sectors
  let best = defaultSector, bestScore = 0;
  for (const [sector, keywords] of Object.entries(SECTOR_KEYWORDS)) {
    const score = keywords.filter(kw => text.includes(kw)).length;
    if (score > bestScore) { bestScore = score; best = sector; }
  }
  return best;
}



function estimateRelevance(title, body) {
  const text = (title + " " + body).toLowerCase();
  const allKw = Object.values(SECTOR_KEYWORDS).flat();
  return Math.min(55 + allKw.filter(kw => text.includes(kw)).length * 6, 98);
}

let currentFilter = (typeof BRIEFING_MODE !== 'undefined' && BRIEFING_MODE) ? 'live' : 'all';
let briefingText = '';
let articles = [];
let nextId = 1;


// Auto-refresh (keeps analysts up to date without manual refresh)
let AUTO_REFRESH_MS = 4 * 60 * 1000; // 4 minutes
let autoTimer = null;

function startAutoRefresh() {
  stopAutoRefresh();
  autoTimer = setInterval(() => loadArticles(currentFilter), AUTO_REFRESH_MS);
}

function stopAutoRefresh() {
  if (autoTimer) clearInterval(autoTimer);
  autoTimer = null;
}

// Pause refresh when tab is not visible (reduces quota / rate-limit risk)
document.addEventListener('visibilitychange', () => {
  if (document.hidden) stopAutoRefresh();
  else startAutoRefresh();
});


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// INIT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded', async () => {
  const d = new Date();
  document.getElementById('current-date').textContent =
    d.toLocaleDateString('en-US', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
  document.getElementById('email-subject-preview').textContent =
    `ALTÂ·Intel Morning Briefing â€” ${d.toLocaleDateString('en-US', { weekday:'short', month:'short', day:'numeric', year:'numeric' })}`;

  await loadArticles();
  startAutoRefresh();
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// LOAD REAL RSS FEEDS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchFeed(feed) {
  const { url, source, sector, paywall } = feed;

  const fetchVia = async (u) => {
    const res = await fetch(u, { cache: 'no-store' });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return await res.text();
  };

  const getProxyUrls = (rssUrl) => {
    const enc = encodeURIComponent(rssUrl);
    const u = new URL(rssUrl);
    const jina = (u.protocol === 'https:' ? (JINA_PROXY_HTTPS + rssUrl.replace(/^https:\/\//,'')) : (JINA_PROXY_HTTP + rssUrl.replace(/^http:\/\//,'')));
    return [
      RAW_PROXY + enc, // AllOrigins raw proxy (CORS-friendly)
      jina            // Jina proxy fallback
    ];
  };

  const parseRSS = (xmlText) => {
    const doc = new DOMParser().parseFromString(xmlText, 'text/xml');
    if (doc.querySelector('parsererror')) throw new Error('RSS parse error');

    // RSS 2.0
    const items = Array.from(doc.querySelectorAll('item'));
    if (items.length) {
      return items.map(it => {
        const title = (it.querySelector('title')?.textContent || '').trim();
        const link = (it.querySelector('link')?.textContent || '').trim();
        const desc = (it.querySelector('description')?.textContent || '').trim();
        const pubDate = (it.querySelector('pubDate')?.textContent || it.querySelector('dc\\:date')?.textContent || '').trim();
        return { title, link, description: desc, pubDate };
      }).filter(x => x.title && x.link);
    }

    // Atom
    const entries = Array.from(doc.querySelectorAll('entry'));
    return entries.map(en => {
      const title = (en.querySelector('title')?.textContent || '').trim();
      const linkEl = en.querySelector('link[rel="alternate"]') || en.querySelector('link');
      const link = (linkEl?.getAttribute('href') || linkEl?.textContent || '').trim();
      const desc = (en.querySelector('summary')?.textContent || en.querySelector('content')?.textContent || '').trim();
      const pubDate = (en.querySelector('updated')?.textContent || en.querySelector('published')?.textContent || '').trim();
      return { title, link, description: desc, pubDate };
    }).filter(x => x.title && x.link);
  };

  // Try proxies (no rss2json dependency)
  let parsed = null;
  const proxies = getProxyUrls(url);
  for (const p of proxies) {
    try {
      const xml = await fetchVia(p);
      parsed = parseRSS(xml);
      if (parsed && parsed.length) break;
    } catch (e) {
      // continue
    }
  }

  if (!parsed) {
    console.warn('Feed failed:', source, url);
    return [];
  }

  return parsed.slice(0, 25).map(item => {
    const clean = (s) => (s || '')
      .replace(/<[^>]*>/g, ' ')
      .replace(/\s+/g, ' ')
      .trim();

    const title = clean(item.title);
    const body = clean(item.description);
    const pub = item.pubDate || '';

    return {
      id: nextId++,
      title,
      body,
      url: item.link,
      source,
      sector: guessSector(title, body, sector),
      paywall: !!paywall,
      time: timeAgo(pub),
      _pubDate: pub || null,
      _ts: (new Date(pub).getTime() || 0),
      rel: 0,
      qscore: 0,
      theme: ''
    };
  });
}


async function loadArticles(sector = null) {
  // Show loading state
  document.getElementById('feed-container').innerHTML =
    `<div style="padding:40px 0;text-align:center;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--ink-dim)">Loading live feeds...</div>`;

  nextId = 1;

  // Fetch all feeds in parallel
  const results = await Promise.all(RSS_FEEDS.map(fetchFeed));
  let all = results.flat();

  // Filter: last 30 days only
  all = all.filter(a => isWithinTimeWindow(a._pubDate));

  // Filter: alts-focused (but Infra/RE friendly)
  if (typeof FILTER_MODE !== 'undefined' && FILTER_MODE === 'smart') {
    all = all.filter(isAltRelevant);
  }


  // Filter to alternative-markets relevant items (sector-aware)
  if (FILTER_MODE === 'smart') {
    all = all.filter(isAltRelevant);
  }

  // Keep feed strictly alternatives (reduces macro noise)
// Sort by recency (most recent first)
  all.sort((a, b) => (b._ts || 0) - (a._ts || 0));
  // Compute quality score + theme
  all = all.map(a => {
    const qa = { ...a };
    qa.qscore = qualityScore(qa);
    qa.theme = classifyTheme(qa);
    return qa;
  });

  // Build Live view list (high-signal only)
  let liveList = all.slice().filter(a => a.qscore >= QUALITY_THRESHOLD_LIVE);
  liveList.sort((a,b)=>(b._ts||0)-(a._ts||0));
  liveList = liveList.slice(0, LIVE_MAX_ITEMS);

  window._liveArticles = liveList;
  window._allArticles = all;

// Deduplicate by "story" â€” cluster across sources and prefer full-access links
  const extractOriginalUrl = (u) => {
    try {
      if (!u) return u;
      const url = new URL(u);
      // Google News RSS often wraps the real URL as a query param
      // Common params: url=, u=
      const qs = url.searchParams;
      const real = qs.get('url') || qs.get('u');
      if (real) return decodeURIComponent(real);
      return u;
    } catch { return u; }
  };

  const getDomain = (u) => {
    try { return (new URL(u)).hostname.replace(/^www\./,''); } catch { return ''; }
  };

  const pickBetter = (a, b) => {
    const aPay = !!a.paywall, bPay = !!b.paywall;

    // 1) Prefer non-paywall (full story accessible)
    if (aPay !== bPay) return aPay ? b : a;

    // 2) Prefer direct publisher over aggregators (e.g., Google News), if access is the same
    const aAgg = /google/i.test(a.source || '') || /news\.google\.com/i.test(a.url || '');
    const bAgg = /google/i.test(b.source || '') || /news\.google\.com/i.test(b.url || '');
    if (aAgg !== bAgg) return aAgg ? b : a;

    // 3) Prefer higher relevance
    const ar = Number(a.rel || 0), br = Number(b.rel || 0);
    if (ar !== br) return ar > br ? a : b;

    // 4) Prefer richer snippet/body
    const al = (a.body || '').length, bl = (b.body || '').length;
    if (al !== bl) return al > bl ? a : b;

    // 5) Prefer newer
    const at = a._ts || 0, bt = b._ts || 0;
    if (at !== bt) return at > bt ? a : b;

    return a;
  };

  const STOP = new Set([
    'the','a','an','and','or','to','of','in','for','on','with','as','at','by','from','into','after','over',
    'its','it','this','that','these','those','says','say','saying','shows','show','memo','report','reports',
    'update','exclusive','breaking'
  ]);

  const cleanTitle = (t) => (t || '')
    .replace(/\s+[-â€“â€”]\s+(reuters|bloomberg(\.com)?|ft(\.com)?|financial times|wsj|wall street journal)\s*$/i,'')
    .replace(/\s+[-â€“â€”]\s+[A-Za-z0-9\.\s]{2,40}\s*$/,'') // generic trailing source tag
    .trim();

  const tokenize = (t) => cleanTitle(t).toLowerCase()
    .replace(/&amp;|&quot;|&#39;/g, ' ')
    .replace(/[^a-z0-9\s]/g, ' ')
    .replace(/\s+/g, ' ')
    .trim()
    .split(' ')
    .filter(w => w && !STOP.has(w) && w.length > 2);

  const signature = (t) => {
    const toks = tokenize(t);
    // Keep order but take first 10 meaningful tokens â€” good clustering across sources
    return toks.slice(0, 10).join(' ');
  };

  // Attach canonical URL + domain
  all = all.map(a => {
    const canon = extractOriginalUrl(a.url);
    return { ...a, _canonUrl: canon, _domain: getDomain(canon) };
  });

  // 1) Strong dedup by canonical URL (when available)
  const byUrl = new Map();
  all.forEach(a => {
    const key = (a._canonUrl || a.url || '').split('#')[0];
    if (!key) return;
    const prev = byUrl.get(key);
    byUrl.set(key, prev ? pickBetter(prev, a) : a);
  });
  all = Array.from(byUrl.values());

  // 2) Story clustering by title signature (handles "same story different source")
  const bySig = new Map();
  all.forEach(a => {
    const key = signature(a.title);
    if (!key) return;
    const prev = bySig.get(key);
    bySig.set(key, prev ? pickBetter(prev, a) : a);
  });
  all = Array.from(bySig.values());

  // 3) Near-duplicate title dedup (Jaccard similarity) â€” catches reworded duplicates across sources
  const jaccard = (A, B) => {
    if (!A.size || !B.size) return 0;
    let inter = 0;
    for (const x of A) if (B.has(x)) inter++;
    const union = A.size + B.size - inter;
    return union ? inter / union : 0;
  };

  const tokenSet = (t) => new Set(tokenize(t)); // tokenize() defined above in this block
  const NEAR_DUP_THRESHOLD = 0.72; // tune: higher = stricter

  const dedupNear = (arr) => {
    const kept = [];
    const sets = [];
    for (const a of arr) {
      const sA = tokenSet(a.title);
      let dupIdx = -1;
      for (let i = 0; i < kept.length; i++) {
        const sim = jaccard(sA, sets[i]);
        if (sim >= NEAR_DUP_THRESHOLD) { dupIdx = i; break; }
      }
      if (dupIdx === -1) {
        kept.push(a); sets.push(sA);
      } else {
        kept[dupIdx] = pickBetter(kept[dupIdx], a);
        sets[dupIdx] = tokenSet(kept[dupIdx].title);
      }
    }
    return kept;
  };

  all = dedupNear(all);

  // 4) Topic throttle â€” reduce "same issuer everywhere" effect (e.g., Blue Owl)
  // Keep up to N stories per entity per sector in last 48h (newest ones win).
  const ENTITY_WINDOW_HOURS = 48;
  const MAX_PER_ENTITY = 2;

  const KNOWN_ENTITIES = [
    "Blue Owl", "Bank of America", "BofA", "Apollo", "Blackstone", "Brookfield", "KKR", "Ares",
    "Carlyle", "Sixth Street", "TPG", "Warburg Pincus", "Thoma Bravo", "Vista", "Advent",
    "Macquarie", "Stonepeak", "IFM", "GIP", "Oaktree"
  ];

  const detectEntity = (title) => {
    if (!title) return "";
    for (const e of KNOWN_ENTITIES) {
      const re = new RegExp("\\b" + e.replace(/[-\/\\^$*+?.()|[\\]{}]/g, "\\$&") + "\\b", "i");
      if (re.test(title)) return e;
    }
    const m = title.match(/^([A-Z][A-Za-z&]+)(\s+[A-Z][A-Za-z&]+){0,2}/);
    return m ? m[0].trim() : "";
  };

  all = all.map(a => ({ ...a, _entity: detectEntity(a.title) }));

  // Sort first so throttle keeps newest
  all.sort((a,b)=>(b._ts||0)-(a._ts||0));

  const cutoff = Date.now() - ENTITY_WINDOW_HOURS*60*60*1000;
  const counts = new Map(); // key: sector|entity
  const throttled = [];
  for (const a of all) {
    const ent = a._entity || "";
    if (!ent) { throttled.push(a); continue; }
    if ((a._ts||0) < cutoff) { throttled.push(a); continue; }
    const key = `${a.sector}|${ent.toLowerCase()}`;
    const c = counts.get(key) || 0;
    if (c < MAX_PER_ENTITY) {
      counts.set(key, c+1);
      throttled.push(a);
    }
  }
  all = throttled;



  // Re-assign sequential IDs
  all = all.map((a, i) => ({ ...a, id: i + 1 }));

  if (all.length === 0) {
    console.warn('All feeds failed â€” showing demo data');
    articles = getDemoArticles();
  } else {
    articles = all;
  }

  currentFilter = sector || 'all';
  renderHero();
  renderFeed();
  renderSidebar();
}

function timeAgo(dateStr) {
  if (!dateStr) return 'recently';
  const diff = Date.now() - new Date(dateStr).getTime();
  const h = Math.floor(diff / 3600000);
  if (h < 1) return 'just now';
  if (h < 24) return `${h}h ago`;
  return `${Math.floor(h/24)}d ago`;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// HERO
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderHero() {
  const top3 = articles.slice(0,3);
  const colors = { PE:'var(--pe-c)', Credit:'var(--credit-c)', Infra:'var(--infra-c)', RE:'var(--re-c)', Hedge:'var(--hedge-c)', Macro:'var(--macro-c)' };
  document.getElementById('hero-strip').innerHTML = top3.map(a => `
    <a class="hero-story" href="${a.url || '#'}" target="_blank" style="cursor:pointer; text-decoration:none; color:inherit; display:block;">
      <div class="hero-kicker" style="color:${colors[a.sector] || 'var(--ink-mid)'}">${a.sector} Â· ${a.source}</div>
      <div class="hero-headline">${a.title}</div>
      <div class="hero-deck">${(a.body||'').substring(0,120)}â€¦</div>
    </div>
  `).join('');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FEED
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderFeed() {
  const base = (window._allArticles && window._allArticles.length) ? window._allArticles : articles;
  const live = (window._liveArticles && window._liveArticles.length) ? window._liveArticles : [];
  const list = (currentFilter === 'live' && BRIEFING_MODE) ? live : (currentFilter === 'all' ? base : base.filter(a => a.sector === currentFilter));
  const allCount = base.length;
  const liveCount = live.length;
  document.getElementById('feed-count').textContent = (currentFilter === 'live' && BRIEFING_MODE)
    ? `â€” ${liveCount} high-signal / ${allCount} total`
    : `â€” ${list.length} article${list.length !== 1 ? 's' : ''}`;

  if (!list.length) {
    document.getElementById('feed-container').innerHTML = `<div style="padding:40px 0; text-align:center; font-family:'JetBrains Mono',monospace; font-size:11px; color:var(--ink-dim)">No articles in this sector</div>`;
    return;
  }

  document.getElementById('feed-container').innerHTML = list.map((a, i) => {
    const rel = a.rel || 75;
    const dots = Array(5).fill(0).map((_,d) => `<span class="rel-dot ${d < Math.round(rel/20) ? 'filled' : ''}"></span>`).join('');
    const articleUrl = a.url || a.link || '#';
    const isPaywall = a.paywall && (!a.url || a.url === '#');
    return `
    <a class="article" style="animation-delay:${i * 0.04}s; text-decoration:none; color:inherit; display:grid; grid-template-columns:1fr auto; gap:16px;" href="${articleUrl}" target="_blank">
      <div class="article-left">
        <div class="article-kicker">
          <span class="sector-pill ${a.sector}">${a.sector}</span>
          <span class="article-source">${a.source}</span>
          <span class="article-time">${a.time}</span>
        </div>
        <div class="article-headline">${a.title}</div>
        <div class="article-body">${a.body || ''}</div>
        ${a.aiSummary ? `
        <div class="ai-summary-wrap">
          <div class="ai-label">âœ¦ AI Analysis</div>
          <div class="ai-text">${a.aiSummary}</div>
        </div>
        ` : ''}
        <div class="article-actions">
          ${a.paywall
            ? '<span class="read-more" style="opacity:0.45; cursor:default;">ðŸ”’ Subscribers Only</span>'
            : '<span class="read-more">Full Story â†’</span>'
          }
          <div class="rel-score"><div class="rel-dots">${dots}</div>${rel}%</div>
          <button class="action-btn ${a.aiSummary ? 'summarized' : ''}"
            onclick="event.preventDefault(); event.stopPropagation(); summarize(${a.id}, this);"
            ${a.aiSummary ? 'disabled' : ''}>
            ${a.aiSummary ? 'âœ“ Analyzed' : 'âš¡ AI Analyze'}
          </button>
        </div>
      </div>
      <div class="article-right">
        <span class="big-number">${String(i+1).padStart(2,'0')}</span>
      </div>
    </a>
  `}).join('');
}


function initActiveNav() {
  const liveBtn = document.getElementById('btn-live');
  const allBtn  = document.getElementById('btn-all');
  document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
  if (currentFilter === 'live' && liveBtn) liveBtn.classList.add('active');
  else if (allBtn) allBtn.classList.add('active');
}

function filter(sector, btn) {
  currentFilter = sector;
  document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  else initActiveNav();
  renderFeed();
  renderSidebar();
}

async function loadFeed() {
  const ico = document.getElementById('refresh-ico');
  ico.classList.add('spin');
  await loadArticles();
  ico.classList.remove('spin');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SIDEBAR
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSidebar() {
  const sectors = ['PE','Credit','Infra','RE','Hedge','Macro'];
  const c = { PE:'var(--pe-c)', Credit:'var(--credit-c)', Infra:'var(--infra-c)', RE:'var(--re-c)', Hedge:'var(--hedge-c)', Macro:'var(--macro-c)' };
  const counts = {};
  sectors.forEach(s => counts[s] = articles.filter(a => a.sector === s).length);
  const max = Math.max(...Object.values(counts), 1);
  document.getElementById('total-articles').textContent = articles.length;

  document.getElementById('sector-stats').innerHTML = sectors.map(s => `
    <div class="sector-stat">
      <span class="stat-name" style="color:${c[s]}">${s}</span>
      <div class="stat-bar"><div class="stat-fill" style="width:${counts[s]/max*100}%; background:${c[s]}"></div></div>
      <span class="stat-n">${counts[s]}</span>
    </div>
  `).join('');

  // Group articles by source for sidebar
  const sourceCounts = {};
  articles.forEach(a => { sourceCounts[a.source] = (sourceCounts[a.source] || 0) + 1; });
  const sources = Object.entries(sourceCounts).sort((x,y) => y[1]-x[1]).slice(0,8);

  document.getElementById('sources-widget').innerHTML = (sources.length ? sources : FALLBACK_SOURCES.map(s => [s.name, s.count])).map(([name, count]) => `
    <div class="source-row">
      <span class="source-n">${count}</span>
      <span class="source-label">${name}</span>
      <span class="source-status-dot ${count > 0 ? 'on' : 'off'}"></span>
    </div>
  `).join('');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// AI: SINGLE ARTICLE â€” via backend
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function summarize(id, btn) {
  try {
    if (!AI_ENABLED) { alert('AI is disabled. Configure the proxy and set AI_ENABLED=true.'); return; }

    const a = articles.find(x => x.id === id);
    if (!a) return;
    if (btn) btn.disabled = true;

    const res = await fetch((API_BASE ? `${API_BASE}/api/summarize` : `/api/summarize`), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        title: a.title,
        url: a.url,
        source: a.source,
        sector: a.sector,
        excerpt: a.body || ''
      })
    });

    if (!res.ok) throw new Error(`Summarize failed: ${res.status}`);
    const data = await res.json();

    a.aiSummary = data.summary || '';
    a.aiScore = data.score ?? null;

    // re-render current view
    renderFeed(currentFilter);
  autoBriefIfNeeded();
} catch (e) {
    console.error(e);
    alert('AI Analyze failed. Check proxy is running and API key is set.');
  } finally {
    if (btn) btn.disabled = false;
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// AI: DAILY BRIEFING â€” via backend
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function generateBriefing() {
  try {
    const btn = document.getElementById('gen-btn');
    if (btn) btn.disabled = true;

    // Use the currently displayed list (filtered + sorted)
    const items = (window._visibleArticles || articles || []).slice(0, 30).map(a => ({
      title: a.title,
      url: a.url,
      source: a.source,
      sector: a.sector,
      time: a.time
    }));

    const res = await fetch((API_BASE ? `${API_BASE}/api/briefing` : `/api/briefing`), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ items })
    });

    if (!res.ok) throw new Error(`Briefing failed: ${res.status}`);
    const data = await res.json();

    const out = document.getElementById('briefing-output');
    if (out) out.textContent = data.briefing || '';
  } catch (e) {
    console.error(e);
    alert('Briefing failed. Check proxy is running and API key is set.');
  } finally {
    const btn = document.getElementById('gen-btn');
    if (btn) btn.disabled = false;
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// EMAIL MODAL
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openEmailModal() {
  document.getElementById('email-modal').classList.add('open');
}

function closeEmailModal() {
  document.getElementById('email-modal').classList.remove('open');
  document.getElementById('success-msg').classList.remove('show');
}

function closeModalOutside(e) {
  if (e.target === document.getElementById('email-modal')) closeEmailModal();
}

async function subscribe() {
  const email = document.getElementById('email-input').value.trim();
  if (!email || !email.includes('@')) {
    document.getElementById('email-input').style.borderColor = 'var(--accent)';
    return;
  }
  const btn = document.getElementById('subscribe-btn');
  btn.disabled = true; btn.textContent = '...';

  try {
    const res = await fetch(`${API_BASE}/subscribe`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email }),
    });
    const data = await res.json();
    if (data.ok) {
      document.getElementById('email-preview-section').style.display = 'none';
      document.getElementById('success-msg').classList.add('show');
    } else {
      btn.disabled = false; btn.textContent = 'Subscribe';
    }
  } catch(e) {
    // Offline fallback
    document.getElementById('email-preview-section').style.display = 'none';
    document.getElementById('success-msg').classList.add('show');
  }
}

function openArticle(a) {
  const url = a.url || a.link;
  if (url && url !== '#') {
    window.open(url, '_blank');
  }
}

function getDemoArticles() {
  return [
    { id:1, sector:"PE", source:"Private Equity Wire", title:"Permira and Warburg Pincus Sell Evelyn Partners to NatWest for Â£2.7bn", body:"Permira and Warburg Pincus agreed to sell UK wealth manager Evelyn Partners to NatWest Group for Â£2.7bn, marking a major consolidation in UK private banking and a significant liquidity event for both PE firms.", time:"2h ago", rel:95, aiSummary:null, url:"https://www.privateequitywire.co.uk/news/" },
    { id:2, sector:"PE", source:"Private Equity Wire", title:"Thoma Bravo Eyes Software Market Downturn Dubbed the SaaSpocalypse", body:"Tech-focused buyout firm Thoma Bravo is looking to capitalise on the ongoing software market downturn, as a disconnect between high-quality firms and riskier software providers creates selective entry points for disciplined PE buyers.", time:"4h ago", rel:91, aiSummary:null, url:"https://www.privateequitywire.co.uk/news/" },
    { id:3, sector:"Hedge", source:"Private Equity Wire", title:"Blackstone Expands Anthropic Stake to Around $1bn at $350bn Valuation", body:"Blackstone has expanded its investment in AI startup Anthropic, bringing its total stake to around $1bn at the current $350bn valuation, signalling continued institutional appetite for AI infrastructure exposure.", time:"5h ago", rel:88, aiSummary:null, url:"https://www.privateequitywire.co.uk/news/" },
    { id:4, sector:"Credit", source:"Private Equity Wire", title:"Apollo Posts 13% Rise in Q4 Profit on Record Debt Origination", body:"Apollo Global Management posted a 13% rise in fourth-quarter profit, surpassing Wall Street estimates, driven by record debt origination and strong inflows from clients seeking private credit alternatives.", time:"7h ago", rel:87, aiSummary:null, url:"https://www.privateequitywire.co.uk/news/" },
    { id:5, sector:"RE", source:"Private Equity Wire", title:"Brookfield and GIC Propose AUD4bn Take-Private of National Storage REIT", body:"National Storage REIT received a AUD4.02bn buyout proposal from a consortium led by Brookfield and GIC, marking what would be Australia largest real-estate take-private deal.", time:"9h ago", rel:84, aiSummary:null, url:"https://www.privateequitywire.co.uk/news/" },
  ];
}
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Daily Executive Brief (auto + editable + email)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const briefStorageKey = () => `altintel_brief_${new Date().toISOString().slice(0,10)}`;

function buildBriefLocal(items) {
  const today = new Date();
  const dateStr = today.toLocaleDateString(undefined, { weekday:'long', year:'numeric', month:'short', day:'numeric' });

  // group by theme
  const groups = new Map();
  items.forEach(a => {
    const key = a.theme || 'Market';
    if (!groups.has(key)) groups.set(key, []);
    groups.get(key).push(a);
  });

  const order = ['Liquidity / Stress','Fundraising','Transactions','Credit / Financing','Secondaries / GP Stakes','AI Impact','Market'];
  const lines = [];
  lines.push(`PRIVATE MARKETS â€“ DAILY BRIEF`);
  lines.push(`${dateStr}`);
  lines.push('');

  let n = 1;
  for (const k of order) {
    const arr = groups.get(k) || [];
    if (!arr.length) continue;
    lines.push(k.toUpperCase());
    arr.slice(0, 4).forEach(a => {
      lines.push(`${n}. ${a.title}`);
      lines.push(`   Source: ${a.source} | Sector: ${a.sector} | ${a.time}`);
      lines.push(`   Link: ${a.url}`);
      lines.push(`   ALT TAKE: (edit) What happened / Why it matters / Watch next`);
      lines.push('');
      n++;
    });
    lines.push('');
  }

  if (n === 1) {
    lines.push('No high-signal stories met the threshold yet. Switch to full sectors to browse everything.');
  }

  return lines.join('\n').trim();
}

async function generateDailyBrief() {
  const out = document.getElementById('briefing-output');
  const btn = document.getElementById('gen-btn');
  try {
    if (btn) btn.disabled = true;

    const base = (window._liveArticles && window._liveArticles.length) ? window._liveArticles : (articles || []);
    const items = base.slice().sort((a,b)=>(b._ts||0)-(a._ts||0)).slice(0, DAILY_BRIEF_MAX_ITEMS);

    // Try AI proxy if configured, else fallback local template
    const api = (typeof API_BASE !== 'undefined' && API_BASE) ? `${API_BASE}/api/briefing` : null;

    if (api) {
      const res = await fetch(api, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ items: items.map(a => ({ title:a.title, url:a.url, source:a.source, sector:a.sector, time:a.time })) })
      });
      if (res.ok) {
        const data = await res.json();
        const txt = data.briefing || '';
        if (out) out.value = txt;
        localStorage.setItem(briefStorageKey(), txt);
        localStorage.setItem('altintel_last_brief_date', new Date().toISOString().slice(0,10));
        return;
      }
    }

    const txt = buildBriefLocal(items);
    if (out) out.value = txt;
    localStorage.setItem(briefStorageKey(), txt);
    localStorage.setItem('altintel_last_brief_date', new Date().toISOString().slice(0,10));
  } catch (e) {
    console.error(e);
    alert('Brief generation failed (proxy optional). Falling back to local template.');
    const base = (window._liveArticles && window._liveArticles.length) ? window._liveArticles : (articles || []);
    const items = base.slice().sort((a,b)=>(b._ts||0)-(a._ts||0)).slice(0, DAILY_BRIEF_MAX_ITEMS);
    const txt = buildBriefLocal(items);
    if (out) out.value = txt;
  } finally {
    if (btn) btn.disabled = false;
  }
}

function autoBriefIfNeeded() {
  const today = new Date().toISOString().slice(0,10);
  const last = localStorage.getItem('altintel_last_brief_date') || '';
  const saved = localStorage.getItem(briefStorageKey());

  const out = document.getElementById('briefing-output');
  if (saved && out && !out.value) out.value = saved;

  // Auto-generate after the configured hour once per day
  const h = new Date().getHours();
  if (h >= DAILY_BRIEF_HOUR_LOCAL && last !== today) {
    generateDailyBrief();
  }
}

function copyBrief() {
  const out = document.getElementById('briefing-output');
  if (!out) return;
  out.select();
  document.execCommand('copy');
}

function emailBrief() {
  const out = document.getElementById('briefing-output');
  const body = encodeURIComponent(out ? out.value : '');
  const subj = encodeURIComponent(`ALT Intel â€“ Daily Brief (${new Date().toISOString().slice(0,10)})`);
  // Opens the user's mail client; you can paste recipients
  window.location.href = `mailto:?subject=${subj}&body=${body}`;
}

</script>
</body>
</html>
